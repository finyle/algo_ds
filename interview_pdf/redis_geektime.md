# https://zhuanlan.zhihu.com/p/697522352
# 源码：
# 一条redis指令的执行过程： server, client 启动初始化 开启事件循环 aeEvent -> networking.readQueryFromClient & ClientAcceptHandler -> server.processCommand, getCommandFlag, addreplay -> networking.sendReplyToClient
## 启动服务，开启事件循环 -> c-s 指令发送， 接收 -> 解析指令并处理 -> 返回响应结果
# 过期： db.*expires
# 渐进式哈希： dict.dictExpand
# 对象生命周期： redisObject.refcount

# 高性能主线，包括线程模型、数据结构、持久化、网络框架；
# 高可靠主线，包括主从复制、哨兵机制；
# 高可扩展主线，包括数据分片、负载均衡。

# ########################################################################
# https://time.geekbang.org/column/intro/100056701?tab=catalog
# Redis 核心技术与实践
# 基础篇
# 1. 基本架构： 一个键值数据库包含什么
#### 可以存哪些数据？ string list set hash zset hyperloglog stream geo 
#### 可以对数据做什么操作？ put get del 
#### 采用什么访问模式？ libs(rocksDB) && socket(memcached, redis) 
#### 如何定位键值对的位置？ index: hash(memcached, redis) && skiplist(rocksDB)
#### 不同操作的具体逻辑是怎样的？ get/scan | put | del 
#### 如何实现重启后快速提供服务？ glibc(malloc, free) | file_read_write

# 2. 数据结构： 快速的Redis有哪些慢操作
#### 键和值用什么结构组织: hash : hash collosion, rehash block
#### 集合数据操作效率? 单元素操作是基础；范围操作非常耗时；统计操作通常高效；例外情况只有几个

# 3. 高性能IO模型： 为什么单线程Redis快
### (Redis 的网络 IO 和键值对读写是由一个线程来完成的，这也是 Redis 对外提供键值存储服务的主要流程。但 Redis 的其他功能，比如持久化、异步删除、集群数据同步等，其实是由额外的线程执行的。)
#### Redis 为什么用单线程？ 多线程编程模式面临的共享资源的并发访问控制问题。
#### 单线程 Redis 为什么那么快？ 多路复用机制

# 4. AOF日志： 宕机后，Redis如何避免数据丢失
#### AOF 日志是如何实现的？ bgrewriteaof ;redo log（重做日志），记录的是修改后的数据, AOF 里记录的是 Redis 收到的每一条命令
#### 三种写回策略: config.appendfsync: always, everysec, no 
#### 日志文件太大了怎么办？ 重写机制具有“多变一”功能
#### AOF 重写会阻塞吗? 一个拷贝，两处日志

# 5. RDB内存快照： 宕机后，Redis如何实现快速恢复
#### 给哪些内存数据做快照？ 全量快照 save & bgsave 
#### 快照时数据能修改吗? cow操作系统提供的写时复制技术
#### 可以每秒做一次快照吗？ 内存快照以一定的频率执行，在两次快照之间，使用 AOF 日志记录这期间的所有命令操作。

# 6. 数据同步： 主从数据库如何实现一致性(一是数据尽量少丢失，二是服务尽量少中断)
#### 主从库间如何进行第一次同步？ 建立连接、协商同步 -> 主库将所有数据同步给从库。从库收到数据后，在本地完成数据加载(rdb) -> 主库会把第二阶段执行过程中新收到的写命令，再发送给从库
#### 主从级联模式分担全量复制时的主库压力? 通过“主 - 从 - 从”模式将主库生成 RDB 和传输 RDB 的压力，以级联的方式分散到从库上。
#### 主从库间网络断了怎么办？ 全量复制、基于长连接的命令传播，以及增量复制: repl_backlog_buffer 是一个环形缓冲区，主库会记录自己写到的位置，从库则会记录自己已经读到的位置

# 7. 哨兵机制：主库挂了，如何不间断服务
#### 哨兵机制的基本流程? 监控、选主（选择主库）和通知
#### 主观下线和客观下线? 哨兵进程会使用 PING 命令检测它自己和主、从库的网络连接情况，用来判断实例的状态
#### 如何选定新主库？ 优先级最高的从库得分高。和旧主库同步程度最接近的从库得分高。ID 号小的从库得分高。

# 8. 哨兵集群：哨兵挂了，主从库还能切换吗
#### 基于 pub/sub 机制的哨兵集群组成? 多个哨兵实例都在主库上做了发布和订阅操作后，它们之间就能知道彼此的 IP 地址和端口。 + info slaveIP
#### 基于 pub/sub 机制的客户端事件通知? 兵就是一个运行在特定模式下的 Redis 实例，只不过它并不服务请求操作，只是完成监控、选主和通知的任务。所以，每个哨兵实例也提供 pub/sub 机制，客户端可以从哨兵订阅消息
#### 由哪个哨兵执行主从切换？ 第一，拿到半数以上的赞成票；第二，拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值。

# 9. 切片集群：数据增多了，是该加内存还是加实例
#### 如何保存更多数据？ 纵向扩展, 横向扩展
#### 数据切片和实例的对应分布关系? 在手动分配哈希槽时，需要把 16384 个槽都分配完，否则 Redis 集群无法正常工作
#### 客户端如何定位数据？ 在集群中，实例有新增或删除，Redis 需要重新分配哈希槽；为了负载均衡，Redis 需要把哈希槽在所有实例上重新分布一遍。 重定向机制

# #######################################################################
# 实践篇
# 1. "万金油"的String， 为什么不好用？
#### 为什么 String 类型内存开销大？ SDS, RedisObject
#### 用什么数据结构可以节省内存？ zpilist(list, hash, sortedSet)
#### 如何用集合类型保存单值的键值对？ 基于 Hash 类型的二级编码

### 2. 有一亿keys要统计，改用哪种集合
#### 聚合统计: Set 的差集、并集和交集的计算复杂度较高;从主从集群中选择一个从库，让它专门负责聚合计算，或者是把数据读取到客户端，在客户端来完成聚合统计
#### 排序统计: List 是按照元素进入 List 的顺序进行排序的，而 Sorted Set 可以根据元素的权重来排序
#### 二值状态统计: Bitmap(setbit, getbit, bitcount)
#### 基数统计: HyperLogLog 的统计规则是基于概率完成的，所以它给出的统计结果是有一定误差的(set, hash精确统计)

### 3. GEO是什么？还可以定义新的数据类型吗？
#### 面向 LBS 应用的 GEO 数据类型: zset + GeoHash encoding 
#### 如何自定义数据类型？ RedisObject 的内部组成包括了 type,、encoding,、lru 和 refcount 4 个元数据，以及 1 个*ptr指针

### 4. 如何在Redis中保存时间序列数据
#### 时间序列数据的读写特点: 插入数据快;单条记录的查询;间范围内的数据做聚合计算
#### 基于 Hash 和 Sorted Set 保存时间序列数据: 不支持对数据进行范围查询;保证写入 Hash 和 Sorted Set 是一个原子性的操作;对时间序列数据进行聚合计算multi,exec
#### 基于 RedisTimeSeries 模块保存时间序列数据:  loadmodule redistimeseries.so

### 5. 消息队列：Redis有哪些解决方案？
#### 消息队列的消息存取需求? 消息保序、处理重复的消息和保证消息可靠性。
#### 基于 List 的消息队列解决方案? 生产者消息发送很快，而消费者处理消息的速度比较慢，这就导致 List 中的消息越积越多，给 Redis 的内存带来很大压力。XREADGROUP：按消费组形式读取消息；XPENDING 和 XACK：XPENDING 命令可以用来查询每个消费组内所有消费者已读取但尚未确认的消息，而 XACK 命令用于向消息队列确认消息处理已完成
#### 基于 Streams(5.0) 的消息队列解决方案

### 6. 异步机制：如何避免单线程的阻塞？
#### Redis 实例有哪些阻塞点？ 客户端：网络 IO，键值对增删改查操作，数据库操作;磁盘：生成 RDB 快照，记录 AOF 日志，AOF 日志重写;主从节点：主库生成、传输 RDB 文件，从库接收 RDB 文件、清空数据库、加载 RDB 文件；切片集群实例：向其他实例传输哈希槽信息，数据迁移。
#### 哪些阻塞点可以异步执行？ (读操作是典型的关键路径操作)  bigkey 删除，清空数据库，以及 AOF 日志同步写。
#### 异步的子线程机制? 异步的键值对删除和数据库清空操作是 Redis 4.0 后提供的功能，Redis 也提供了新的命令来执行这两个操作。

# 7. 为什么CPU结构会影响Redis的性能？
#### 主流的 CPU 架构: cpu, l1, l2 cache 
#### CPU 多核对 Redis 性能的影响: 每调度一次，一些请求就会受到运行时信息、指令和数据重新加载过程的影响，这就会导致某些请求的延迟明显高于其他请求。taskset -c 0 ./redis-server 
#### CPU 的 NUMA 架构对 Redis 性能的影响: lscpu
#### 绑核的风险和解决方案: 一个 Redis 实例对应绑一个物理核; 优化 Redis 源码,把子进程和后台线程绑到不同的 CPU 核上。

# 8. 波动的响应延迟：如何应该变慢的Redis?
#### Redis 真的变慢了吗？ 查看 Redis 的响应延迟。./redis-cli --intrinsic-latency 120
#### 如何应对 Redis 变慢？  慢查询命令(用其他高效命令代替|执行排序、交集、并集操作), 过期 key 操作(频繁使用带有相同时间参数的 EXPIREAT 命令设置过期 key)

#### 文件系统：AOF 模式: AOF 重写会对磁盘进行大量 IO 操作，同时，fsync 又需要等到数据写到磁盘后才能返回，所以，当 AOF 重写的压力比较大时，就会导致 fsync 被阻塞
#### 操作系统：swap: 内存 swap 是操作系统里将内存数据在内存和磁盘间来回换入和换出的机制，涉及到磁盘的读写，所以，一旦触发 swap，无论是被换入数据的进程，还是被换出数据的进程，其性能都会受到慢速磁盘读写的影响
#### 操作系统：内存大页: Linux 内核从 2.6.38 开始支持内存大页机制，该机制支持 2MB 大小的内存页分配，而常规的内存页分配是按 4KB 的粒度来执行的。

# 9. 删除数据后，为什么内存占用率还是很高？
#### 什么是内存碎片？ Redis 释放的内存空间可能并不是连续的，那么，这些不连续的内存空间很有可能处于一种闲置的状态
#### 内存碎片是如何形成的？ 内存分配器的分配策略;键值对大小不一样和删改操作
#### 如何判断是否有内存碎片？ info memory -> mem_fragmentation_ratio:1.86
#### 如何清理内存碎片？ 重启 Redis 实例; 4.0-RC3 版本以后，Redis 自身提供了一种内存碎片自动清理的方法，我们先来看这个方法的基本机制。

# 10. 缓冲区：一个可能引发“惨案”的地方？
#### 客户端输入和输出缓冲区? client-list: ，一是把缓冲区调大，二是从数据命令的发送和处理速度入手。 服务器端返回 bigkey 的大量结果；执行了 MONITOR 命令；缓冲区大小设置得不合理。
#### 主从集群中的缓冲区? 复制缓冲区的溢出问题; 复制积压缓冲区的溢出问题

# 11. 旁路缓存: Redis是如何工作的
#### 缓存的特征? CPU 里面的末级缓存;内存中的高速页缓存
#### Redis 缓存处理请求的两种情况?  缓存命中; 缓存缺失
#### Redis 作为旁路缓存的使用操作? 
#### 缓存的类型? 只读缓存; 读写缓存

# 12. 替换策略：缓存满了怎么办？
#### 设置多大的缓存容量合适？ CONFIG SET maxmemory 4gb
#### Redis 缓存有哪些淘汰策略？ 设置了过期时间的数据中进行淘汰; 所有数据范围内进行淘汰
#### 如何处理被淘汰的数据？ 干净数据，那么我们就直接删除

# 13. 缓存异常：缓存和数据库的不一致问题 & 如何解决缓存雪崩，击穿，穿透
#### 缓存和数据库的数据不一致是如何发生的？ 缓存中有数据; 缓存中本身没有数据
#### 如何解决数据不一致问题？ 先删除缓存，再更新数据库; 先更新数据库值，再删除缓存值

#### 缓存雪崩: 大量的应用请求无法在 Redis 缓存中进行处理，紧接着，应用将大量请求发送到数据库层，导致数据库层的压力激增
#### 缓存击穿: 针对某个访问非常频繁的热点数据的请求，无法在缓存中进行处理
#### 缓存穿透: 要访问的数据既不在 Redis 缓存中，也不在数据库中，导致请求在访问缓存时，发生缓存缺失，再去访问数据库时，发现数据库中也没有要访问的数据

# 14. 缓存被污染？
#### 如何解决缓存污染问题？ 把不会再被访问的数据筛选出来并淘汰掉
#### LRU 缓存策略? 因为只看数据的访问时间，使用 LRU 策略在处理扫描式单次查询操作时，无法解决缓存污染
#### LFU 缓存策略的优化? 在 LRU 策略基础上，为每个数据增加了一个计数器，来统计这个数据的访问次数

# 15. Pika： 如何基于SSD实现大容量Redis
#### 大内存 Redis 实例的潜在问题?  内存快照 RDB 生成和恢复效率低，以及主从节点全量同步时长增加、缓冲区易溢出
#### Pika 如何基于 SSD 保存更多数据？
#### Pika 如何实现 Redis 数据类型兼容？
#### Pika 的其他优势与不足? 

# 16. 无锁的原子操作： Redis如何应对并发访问
#### 并发访问中需要对什么进行控制？对多个客户端访问操作同一份数据的过程进行控制，以保证任何一个客户端发送的操作在 Redis 实例上执行时具有互斥性
#### Redis 的两种原子操作方法? 把多个操作在 Redis 中实现成一个操作，也就是单命令操作；把多个操作写到一个 Lua 脚本中，以原子性方式执行单个 Lua 脚本。

# 17. 如何使用Redis实现分布式锁
#### 单机上的锁和分布式锁的联系与区别? 加锁和释放锁的操作就变成了读取、判断和设置共享存储系统中的锁变量值。
#### 基于单个 Redis 节点实现分布式锁? set key value nx px 10000; lua_script(redis.call())
#### 基于多个 Redis 节点实现高可靠的分布式锁? 客户端获取当前时间; 客户端按顺序依次向 N 个 Redis 实例执行加锁操作; 一旦客户端完成了和所有 Redis 实例的加锁操作，客户端就要计算整个加锁过程的总耗时。

# 18. 事务机制：Redis能实现ACID属性吗？ 
#### 事务 ACID 属性的要求? 
#### Redis 如何实现事务？ multi, decr/incr/set/get, discard/exec 
#### Redis 的事务机制能保证哪些属性？ 可以保证一致性和隔离性，但是无法保证持久性

# 19. Redis主从同步与故障切换(33)？
#### 主从数据不一致? 主从库间的命令复制是异步进行的。
#### 读取过期数据? Redis 的过期数据删除策略
#### 不合理配置项导致的服务挂掉? protected-mode 和 cluster-node-timeout

# 20. 脑裂： 一次奇怪的数据丢失 (在主从集群中，同时有两个主节点，它们都能接收写请求)
#### 为什么会发生脑裂？ 确认是不是数据同步出现了问题; 排查客户端的操作日志，发现脑裂现象; 发现是原主库假故障导致的脑裂
#### 为什么脑裂会导致数据丢失？ 主从切换后，从库一旦升级为新主库，哨兵就会让原主库执行 slave of 命令，和新主库重新进行全量同步。而在全量同步执行的最后阶段，原主库需要清空本地的数据，加载新主库发送的 RDB 文件，这样一来，原主库在主从切换期间保存的新写数据就丢失了
#### 如何应对脑裂问题？ min-slaves-to-write：这个配置项设置了主库能进行数据同步的最少从库数量； min-slaves-max-lag：这个配置项设置了主从库间进行数据复制时，从库给主库发送 ACK 消息的最大延迟

# 21. Codis VS Redis Cluster 选择哪个集群方案？
#### Codis 的整体架构和基本流程? codis server; codis proxy; Zookeeper 集群; codis dashboard 和 codis fe
#### Codis 的关键技术原理? 数据如何在集群里分布; 集群扩容和数据迁移如何进行;集群客户端需要重新开发吗

# 22. Redis 支撑秒杀场景的关键计数实践
#### 秒杀场景的负载特征对支撑系统的要求? 瞬时并发访问量非常高; 读多写少，而且读操作是简单的查询操作。
#### Redis 可以在秒杀场景的哪些环节发挥作用？
#### Redis 的哪些方法可以支撑秒杀场景？ 支持高并发; 保证库存查验和库存扣减原子性执行

# 23. 数据分布优化： 如何应对数据倾斜
#### 数据量倾斜的成因和应对方法? bigkey 导致倾斜; Slot 分配不均衡导致倾斜; Hash Tag 导致倾斜
#### 数据访问倾斜的成因和应对方法? 热点数据多副本

# 24. 通信开销： 限制Redis Cluster规模的关键因素
#### 实例通信方法和对集群规模的影响? 为了让集群中的每个实例都知道其它所有实例的状态信息，实例之间会按照一定的规则进行通信。这个规则就是 Gossip 协议。 Gossip 消息大小; 实例间通信频率
#### 如何降低实例间的通信开销？ 可以在调整 cluster-node-timeout 值的前后，使用 tcpdump 命令抓取实例发送心跳信息网络包的情况。

